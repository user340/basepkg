#!/bin/sh
# shellcheck disable=SC2039

_split_category()
{
    _logging "===> _split_category()"

    local moduledir="stand/$machine/$release_k/modules"

    for i in $category; do
        local category_dir="$lists/$i"

        _mkdir_if_not_exists "$workdir/$i"
        _remove_if_exists "$workdir/$i/FILES"

        ad="$(_print_if_file_exists "$category_dir/ad.$machine")"
        mi="$(_print_if_file_exists "$category_dir/mi")"
        md="$(_print_if_file_exists "$category_dir/md.$machine")"
        module="$(_print_if_file_exists "$category_dir/module.mi")"
        rescue="$(_print_if_file_exists "$category_dir/rescue.mi")"
        rescue_ad="$(_print_if_file_exists "$category_dir/rescue.ad.$machine")"
        rescue_machine="$(_print_if_file_exists "$category_dir/rescue.$machine")"
        shl="$(_print_if_file_exists "$category_dir/shl.mi")"
        stl="$(_print_if_file_exists "$category_dir/stl.mi")"

        # shellcheck disable=SC2086
        cat \
            $ad $mi $md $module $rescue $rescue_ad \
            $rescue_machine $shl $stl \
        | awk '
            ! /^\#/ {
                #
                # Ignore obsolete packages.
                #
                if ($2 == "'"$i-obsolete"'")
                    next
                #
                # Ignore package with obsolete tags.
                #
                if ($3 ~ "obsolete")
                    next
                if ($2 ~ "^'"$i"'") {
                    #
                    # Remove "./" characters.
                    #
                    $1 = substr($1, 3);
                    if ($1 != "") {
                        gsub(/@MODULEDIR@/, "'"$moduledir"'");
                        gsub(/@MACHINE@/, "'"$machine"'");
                        gsub(/@OSRELEASE@/, "'"$release_k"'");
                        print
                    }
                }
            }' >> "$workdir/$i/FILES"
    done
}

_make_package_directories()
{
    _logging "===> _make_package_directories()"
    for i in $category; do
        awk '{print $2}' "$workdir/$i/FILES" | sort -u \
        | xargs -n 1 -I % sh -c "test -d $workdir/$i/% || mkdir $workdir/$i/%"
    done
}

_generate_PLIST()
{
    _logging "===> _generate_PLIST()"
    for i in $category; do
        awk '
        # $1 - file name
        # $2 - package name
        {
            if ($2 in lists)
                lists[$2] = $1 " " lists[$2]
            else
                lists[$2] = $1
        }
        END {
            for (pkg in lists)
                print pkg, lists[pkg]
        }' "$workdir/$i/FILES" > "$workdir/$i/CATEGORIZED"
    done
    i=""
    for i in $category; do
        for j in "$workdir/$i"/*; do
            test -d "$j" || continue
            awk '
            /^'"$(basename "$j")"'/ {
                for (i = 2; i <= NF; i++) {
                    print $i
                }
            }' "$workdir/$i/CATEGORIZED" > "$j/PLIST"
        done
    done
}

_generate_BUILD_INFO()
{
    local package="$workdir/$1"

    cat > "$package/+BUILD_INFO" << _BUILD_INFO_
OPSYS=$opsys
OS_VERSION=$osversion
OBJECT_FMT=ELF
MACHINE_ARCH=$machine_arch
PKGTOOLS_VERSION=$pkgtoolversion
HOMEPAGE=$homepage
MAINTAINER=$mail_address
_BUILD_INFO_
}

_mk_depend()
{
    grep "^$1" "$deps" > /dev/null 2>&1
    if [ $? -eq 1 ]; then
        _error "$1 Unknown package dependency."
        return 1
    fi
    awk '/^'"$1"'/{print $2}' "$deps" | while read -r depend; do
        test ! "$depend" && return 1

    # XXX EXTENSION: check dependency generated by nbpkg-build.
    # XXX $nbpkg_build_list_all knows changes based on ident comparison
    # XXX where the format is such as "base-sys-root 8.0.20181101".
    if [ "X$nbpkg_build_config" != "X" ];then
        _sep="[[:space:]]"
        _release=$(grep "^${depend}$_sep" $nbpkg_build_list_all    |
                   awk '{print $2}'                                |
                   tail -1                                         )
        if [ "X$_release" != "X" ];then
            echo "@pkgdep $depend>=$_release"
        fi
    else
        echo "@pkgdep $depend>=$release"
    fi  >> "$tmp_deps"
        test "$depend" = "base-sys-root" && return 0
        _mk_depend "$depend" # Recursion.
    done
}

_generate_CONTENTS()
{
    local TMPFILE=$(mktemp -q || _bomb "$TMPFILE")
    local setname="${1%/*}" # E.g. "base/base-sys-root" --> "base"
    local pkgname="${1#*/}" # E.g. "base/base-sys-root" --> "base-sys-root"
    local prefix="/"
    if [ "$setname" = "etc" ]; then
        prefix="/var/tmp/basepkg"
    fi
    local package="$workdir/$1"

    echo "@name $pkgname-$release" > "$package/+CONTENTS"
    echo "@comment Packaged at $utcdate UTC by $user@$host" >> "$package/+CONTENTS"

    _remove_if_exists "$tmp_deps"
    _mk_depend "$pkgname"
    test -f "$tmp_deps" && sort -u "$tmp_deps" >> "$package/+CONTENTS"

    echo "@cwd $prefix" >> "$package/+CONTENTS"
    while read -r i; do
        if [ -d "$destdir/$i" ]; then
            filename=$(echo "$i" | sed 's%\/%\\\/%g')
            awk '$1 ~ /^\.\/'"$filename"'$/{print $0}' "$destdir/etc/mtree/set.$setname" \
            | sed 's%^\.\/%%' \
            | awk '
            {
                print "@exec install -d -o root -g wheel -m "substr($5, 6) " "$1
            } ' >> "$TMPFILE"
        fi
        test -f "$destdir/$i" && echo "$i" >> "$TMPFILE"
    done < "$package/PLIST"

    sort "$TMPFILE" >> "$package/+CONTENTS"
    rm -f "$TMPFILE"
}

_generate_SIZE_PKG()
{
    local package="$workdir/$1"

    # Sum of file size.
    grep -v '^@' < "$package/+CONTENTS" \
        | xargs -I % ls -l "$destdir/"% \
        | awk '{sum+=$5} END{print sum}' \
        > "$package/+SIZE_PKG.tmp"

    # Sum of directory size.
    grep -c '^@exec install -d -o root -g wheel -m' < "$package/+CONTENTS" \
        | xargs -I % expr % \* 512 \
        >> "$package/+SIZE_PKG.tmp"

    # Sum of file and directory size.
    awk '{sum+=$1} END{print sum}' < "$package/+SIZE_PKG.tmp" \
        > "$package/+SIZE_PKG"

    rm -f "$package/+SIZE_PKG.tmp"
}

_generate_SIZE_ALL()
{
    local package="$workdir/$1"

    grep '^@pkgdep' "$package/+CONTENTS" \
        | cut -d " " -f 2 \
        | awk 'FS=">=" {print $1}' \
        | xargs -I % find "$workdir" -type d -name % \
        | xargs -I % cat %/+SIZE_PKG \
        | awk '{sum+=$1} END{print sum}' \
        > "$package/+SIZE_ALL.tmp"

    cat "$package/+SIZE_PKG" "$package/+SIZE_ALL.tmp" \
        | awk '{sum+=$1}END{print sum}' \
        > "$package/+SIZE_ALL"

    rm -f "$package/+SIZE_ALL.tmp"
}

_generate_DESC_and_COMMENT()
{
    local pkgname="${1#*/}"
    local package="$workdir/$1"

    awk '
    /^'"$pkgname"'/ {
        for (i = 2; i <= NF; i++) {
            if (i == NF)
                printf $i"\n"
            else
                printf $i" "
        }
    }' "$descrs" > "$package/+DESC" || _bomb "awk +DESC"

    awk '
    /^'"$pkgname"'/ {
        for (i = 2; i <= NF; i++) {
            if (i == NF)
                printf $i"\n"
            else
                printf $i" "
        }
    }' "$comments" > "$package/+COMMENT" || _bomb "awk +COMMENT"
}

_replace_cmdstr()
{
    sed -e "s%@GROUPADD@%/usr/sbin/groupadd%g" \
        -e "s%@USERADD@%/usr/sbin/useradd%" \
        -e "s%@SH@%/bin/sh%" \
        -e "s%@PREFIX@%/%" \
        -e "s%@AWK@%/usr/bin/awk%" \
        -e "s%@BASENAME@%/usr/bin/basename%" \
        -e "s%@CAT@%/bin/cat%" \
        -e "s%@CHGRP@%/bin/chgrp%" \
        -e "s%@CHMOD@%/bin/chmod%" \
        -e "s%@CHOWN@%/sbin/chown%" \
        -e "s%@CMP@%/usr/bin/cmp%" \
        -e "s%@CP@%/bin/cp%" \
        -e "s%@DIRNAME@%/usr/bin/dirname%" \
        -e "s%@ECHO@%echo%" \
        -e "s%@EGREP@%/usr/bin/egrep%" \
        -e "s%@EXPR@%/bin/expr%" \
        -e "s%@FALSE@%/usr/bin/false%" \
        -e "s%@FIND@%/usr/bin/find%" \
        -e "s%@GREP@%/usr/bin/grep%" \
        -e "s%@GTAR@%/bin/tar%" \
        -e "s%@HEAD@%/usr/bin/head%" \
        -e "s%@ID@%/usr/bin/id%" \
        -e "s%@LINKFARM@%linkfarm%" \
        -e "s%@LN@%/bin/ln%" \
        -e "s%@LOCALBASE@%localbase%" \
        -e "s%@LS@%/bin/ls%" \
        -e "s%@MKDIR@%/bin/mkdir -p%" \
        -e "s%@MV@%/bin/mv%" \
        -e "s%@PKGBASE@%/%" \
        -e "s%@RM@%/bin/rm%" \
        -e "s%@RMDIR@%/bin/rmdir%" \
        -e "s%@SED@%/usr/bin/sed%" \
        -e "s%@SETENV@%setenv%" \
        -e "s%@ECHO_N@%echo -n%" \
        -e "s%@PKG_ADMIN@%pkg_admin%" \
        -e "s%@PKG_INFO@%pkg_info%" \
        -e "s%@PWD_CMD@%pwd%" \
        -e "s%@SORT@%/usr/bin/sort%" \
        -e "s%@SU@%/usr/bin/su%" \
        -e "s%@TEST@%test%" \
        -e "s%@TOUCH@%/usr/bin/touch%" \
        -e "s%@TR@%/usr/bin/tr%" \
        -e "s%@TRUE@%/usr/bin/true%" \
        -e "s%@XARGS@%/usr/bin/xargs%" \
        -e "s%@X11BASE@%/usr/X11R7%" \
        -e "s%@PKG_SYSCONFBASE@%/etc%" \
        -e "s%@PKG_SYSCONFBASEDIR@%/etc%" \
        -e "s%@PKG_SYSCONFDIR@%/etc%" \
        -e "s%@CONF_DEPENDS@%%" \
        -e "s%@PKG_CREATE_USERGROUP@%NO%" \
        -e "s%@PKG_CONFIG@%YES%" \
        -e "s%@PKG_CONFIG_PERMS@%YES%" \
        -e "s%@PKG_RCD_SCRIPTS@%NO%" \
        -e "s%@PKG_USER_HOME@%%" \
        -e "s%@PKG_USER_SHELL@%%" \
        -e "s%@PERL5@%$(command -v perl)%" "$1" || _bomb "failed sed"
}

_generate_INSTALL()
{
    local package="$workdir/$1"
    local user_group_mode=""
    local _mode=""
    local _user=""
    local _group=""

    _remove_if_exists "$package/+INSTALL"
    _replace_cmdstr "$install_script" > "$package/+INSTALL"
    _bomb_if_not_found "$package/+CONTENTS"

    # For +FILES routine which is conained in sets/install script.
    grep -v -e "^@" "$package/+CONTENTS" | while read -r file; do
        test "$(file "$obj/$file" | cut -d " " -f 2)" = "symbolic" && continue
        if [ "${file%%/*}" = "etc" ]; then
            if [ -f "$destdir/$file" ]; then
                user_group_mode=$(grep -e "^\\./$file " "$destdir/etc/mtree/set.etc" \
                                    | cut -d " " -f 3 -f 4 -f 5 \
                                    | xargs -n 1 -I % expr x% : "x[^=]*=\\(.*\\)" \
                                    | tr '\n' ' '
                                )
                _mode=$(echo "$user_group_mode" | cut -d " " -f 3)
                _user=$(echo "$user_group_mode" | cut -d " " -f 1)
                _group=$(echo "$user_group_mode" | cut -d " " -f 2)
            fi
            echo "# FILE: /$file c $file $_mode $_user $_group" \
                >> "$package/+INSTALL"
        fi
    done
}

_generate_DEINSTALL()
{
    _replace_cmdstr "$deinstall_script" > "$workdir/$1/+DEINSTALL"
}

_generate_PRESERVE()
{
    local essential_path=""

    while read -r essential_pkg; do
        essential_path=$(find "$workdir" -name "$essential_pkg" -type d)
        printf "%s-%s" "$essential_pkg" "$release" > "$essential_path/+PRESERVE"
    done < "$essential"
}

_put_basedir()
{
   if [ "X$machine_arch" != "X$machine" ]; then
     echo "$packages/$release/$machine-$machine_arch"
   else
     echo "$packages/$release/$machine"
   fi
}

_do_pkg_create()
{
    local setname="${1%/*}" # E.g. "base/base-sys-root" --> "base"
    local pkgname="${1#*/}" # E.g. "base/base-sys-root" --> "base-sys-root"
    local option="-v -l -U
    -B $workdir/$1/+BUILD_INFO
    -i $workdir/$1/+INSTALL
    -K $pkgdb
    -k $workdir/$1/+DEINSTALL
    -p $destdir
    -c $workdir/$1/+COMMENT
    -d $workdir/$1/+DESC
    -f $workdir/$1/+CONTENTS
    -s $workdir/$1/+SIZE_PKG
    -S $workdir/$1/+SIZE_ALL"
    local package="$workdir/$1"

    test -f "$package/+PRESERVE" && option="$option -n $package/+PRESERVE"

    if [ "$setname" = "etc" ]; then
        option="$option -I /var/tmp/basepkg"
    else
        option="$option -I /"
    fi

    # shellcheck disable=SC2086
    /usr/pkg/sbin/pkg_create $option "$pkgname" || _bomb "$1: pkg_create"

    local _basedir=$(_put_basedir)
    _mkdir_if_not_exists "$_basedir"
    mv "./$pkgname.tgz" "$_basedir/$pkgname-$release.tgz"
}

_mk_checksum()
{
    local MD5_CMD
    local SHA512_CMD

    MD5_CMD=$(_set_md5_sum)
    SHA512_CMD=$(_set_sha512_sum)

    find ./*.tgz -exec $MD5_CMD {} \; > MD5
    find ./*.tgz -exec $SHA512_CMD {} \; > SHA512
}

_find_package_directory()
{
    find "$workdir" -type d -name '*-*-*' | sed "s|$workdir/||g"
}

_is_nbpkg_daily_build()
{
    [ "X$nbpkg_build_config" != "X" ] && [ "X$nbpkg_build_target" = "Xdaily" ]
}

_make_all_packages()
{
    _logging "===> _make_all_packages()"
    _find_package_directory | while read -r pkg; do
        _generate_BUILD_INFO "$pkg"
        _generate_CONTENTS "$pkg"
        _generate_SIZE_PKG "$pkg"
        _generate_DESC_and_COMMENT "$pkg"
        _generate_INSTALL "$pkg"
        _generate_DEINSTALL "$pkg"
    done

    # XXX EXTENSION: build least packages specified by nbpkg-build
    if _is_nbpkg_daily_build; then
        _find_package_directory | egrep -f $nbpkg_build_list_filter
    else
        _find_package_directory
    fi | while read -r pkg; do
        _generate_SIZE_ALL "$pkg"
        _do_pkg_create "$pkg"
    done

    local _basedir=$(_put_basedir)
    cd "$_basedir" && _mk_checksum
}

_mk_kernel_package()
{
    local category="base"
    local pkgname="base-kernel-$1"
    local package="$workdir/$category/$pkgname"

    if [ ! -f "$obj/sys/arch/$machine/compile/$1/netbsd" ]; then
        _error "$1/netbsd not found."
        return 1
    fi

    _mkdir_if_not_exists "$package"

    # Information of build environment.
    cat > "$package/+BUILD_INFO" << _BUILD_INFO_
OPSYS=$opsys
OS_VERSION=$osversion
OBJECT_FMT=ELF
MACHINE_ARCH=$machine_arch
PKGTOOLS_VERSION=$pkgtoolversion
_BUILD_INFO_

    # Short description of package.
    cat > "$package/+COMMENT" << _COMMENT_
NetBSD $1 Kernel
_COMMENT_

    # Description of package.
    cat > "$package/+DESC" << _DESC_
NetBSD $1 Kernel
_DESC_

    # Package contents.
    cat > "$package/+CONTENTS" << _CONTENTS_
@name $pkgname-$release
@comment Packaged at $utcdate UTC by $user@$host
@cwd /
netbsd
_CONTENTS_

    # Size of kernel.
    du "$obj/sys/arch/$machine/compile/$1/netbsd" \
        | cut -f 1 \
        > "$package/+SIZE_PKG"

    # XXX: Size all.
    cp "$package/+SIZE_PKG" "$package/+SIZE_ALL"

    /usr/pkg/sbin/pkg_create -v -l -U \
    -B "$package/+BUILD_INFO" \
    -I "/" \
    -c "$package/+COMMENT" \
    -d "$package/+DESC" \
    -f "$package/+CONTENTS" \
    -p "$obj/sys/arch/$machine/compile/$1" \
    -s "$package/+SIZE_PKG" \
    -S "$package/+SIZE_ALL" \
    -K "$pkgdb" "$pkgname" || _bomb "kernel: pkg_create"

    _basedir=$(_put_basedir)
    _mkdir_if_not_exists "$_basedir"
    mv "$PWD/$pkgname.tgz" "$_basedir/$pkgname-$release.tgz"
}

_make_all_kernel_packages()
{
    # XXX: A number of kernel packages can install to the system.
    _logging "===> _make_all_kernel_packages()"
    # shellcheck disable=SC2086
    # shellcheck disable=SC2012
    ls $kernobj | while read -r kernel_name; do
        _mk_kernel_package "$kernel_name"
    done
}
